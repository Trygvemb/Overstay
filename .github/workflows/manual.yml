name: Issue Automation

on:
  push:
    branches:
      - '**'
  pull_request:
    types: [opened, closed]

jobs:
  move-issue:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Extract branch name
      if: github.event_name == 'push'
      id: extract-branch
      run: echo "::set-output name=branch::$(echo ${GITHUB_REF#refs/heads/})"

    - name: Move linked issue to In Progress
      if: github.event_name == 'push'
      uses: peter-evans/create-or-update-comment@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        issue-number: ${{ github.event.head_commit.message | fromJson | contains('issue #') | split(' ') | last }}
        body: |
          - [ ] 🏗️ Work in Progress: ${{ steps.extract-branch.outputs.branch }}

    - name: Move linked issue to In Review
      if: github.event_name == 'pull_request' && github.event.action == 'opened'
      uses: peter-evans/create-or-update-comment@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        issue-number: ${{ github.event.pull_request.body | fromJson | contains('issue #') | split(' ') | last }}
        body: |
          - [ ] 🔍 In Review: PR #${{ github.event.pull_request.number }}

    - name: Move linked issue to Done
      if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
      uses: peter-evans/create-or-update-comment@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        issue-number: ${{ github.event.pull_request.body | fromJson | contains('issue #') | split(' ') | last }}
        body: |
          - [ ] ✅ Done: PR #${{ github.event.pull_request.number }} merged
